<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GRAPHITE SKETCH</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
            background: #000;
            color: #fff;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: hidden;
        }

        #video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        #canvas {
            display: none;
        }

        /* Target frame overlay */
        #targetFrame {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 300px;
            height: 300px;
            border: 3px dashed #FFD700;
            border-radius: 12px;
            pointer-events: none;
            z-index: 10;
            box-shadow: 0 0 20px rgba(255, 215, 0, 0.5);
            transition: opacity 0.3s;
        }

        #targetFrame.hidden {
            opacity: 0;
        }

        /* Instructions */
        #instructions {
            position: absolute;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 16px 24px;
            border-radius: 8px;
            text-align: center;
            z-index: 20;
            max-width: 90%;
        }

        #instructions h2 {
            font-size: 18px;
            margin-bottom: 8px;
            color: #FFD700;
        }

        #instructions p {
            font-size: 14px;
            color: #fff;
        }

        /* Bell button */
        #bellButton {
            position: absolute;
            bottom: 40px;
            left: 50%;
            transform: translateX(-50%);
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FFD700, #FFA500);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 20px rgba(255, 215, 0, 0.6);
            z-index: 30;
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s;
        }

        #bellButton.visible {
            opacity: 1;
            pointer-events: auto;
        }

        #bellButton:hover {
            transform: translateX(-50%) scale(1.1);
        }

        #bellButton:active {
            transform: translateX(-50%) scale(0.95);
        }

        #bellButton svg {
            width: 35px;
            height: 35px;
            fill: #fff;
        }

        /* AR Overlay container */
        #arOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 5;
        }

        /* Aarti effects */
        .aarti-container {
            position: absolute;
            width: 300px;
            height: 300px;
            pointer-events: none;
            display: none;
        }

        .aarti-container.active {
            display: block;
        }

        /* Lamp icon */
        .lamp {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80px;
            height: 80px;
            animation: rotateLamp 2s linear;
        }

        @keyframes rotateLamp {
            from { transform: translate(-50%, -50%) rotate(0deg); }
            to { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* Flowers */
        .flower {
            position: absolute;
            width: 30px;
            height: 30px;
            font-size: 30px;
            animation: fall 2s ease-in;
            opacity: 0;
        }

        @keyframes fall {
            0% { top: -40px; opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        /* Smoke */
        .smoke {
            position: absolute;
            bottom: 0;
            width: 60px;
            height: 60px;
            background: radial-gradient(circle, rgba(255,255,255,0.6), transparent);
            border-radius: 50%;
            animation: rise 2s ease-out;
            opacity: 0;
        }

        @keyframes rise {
            0% { bottom: 0; opacity: 0.8; transform: scale(0.5); }
            100% { bottom: 100%; opacity: 0; transform: scale(1.5); }
        }

        /* GIF overlay */
        .gif-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }

        .gif-overlay.active {
            display: block;
        }

        /* Start screen */
        #startScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        #startScreen h1 {
            font-size: 32px;
            margin-bottom: 20px;
            text-align: center;
            padding: 0 20px;
        }

        #startButton {
            padding: 16px 48px;
            font-size: 18px;
            background: #fff;
            color: #667eea;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-weight: 600;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }

        #startButton:hover {
            transform: scale(1.05);
        }

        #startButton:active {
            transform: scale(0.95);
        }

        /* Status indicator */
        #status {
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 25;
            display: none;
        }

        #status.show {
            display: block;
        }
    </style>
</head>
<body>
    <div id="startScreen">
        <h1>GRAPHITE SKETCH DARSHAN</h1>
        <button id="startButton">Start Camera</button>
    </div>

    <div id="container">
        <video id="video" playsinline autoplay></video>
        <canvas id="canvas"></canvas>
        
        <div id="targetFrame"></div>
        
        <div id="instructions">
            <h2>Align Your Image</h2>
            <p>Place the image inside the golden frame</p>
        </div>

        <div id="status"></div>

        <button id="bellButton">
            <svg viewBox="0 0 24 24">
                <path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/>
            </svg>
        </button>

        <div id="arOverlay"></div>
    </div>

    <audio id="bgMusic" loop>
        <source src="song.mp3" type="audio/mpeg">
    </audio>

    <script>
        // Configuration
        const CONFIG = {
            targetImageSrc: 'graphite-target.png',
            gifSources: ['1.gif', '2.gif', '3.gif'],
            musicSrc: 'song.mp3',
            matchThreshold: 0.65,
            stableFrames: 15,
            aartiDuration: 2000
        };

        // Global state
        const state = {
            isTracking: false,
            isLocked: false,
            targetImage: null,
            lockedPosition: null,
            stableCount: 0,
            currentGifIndex: 0,
            isPlaying: false
        };

        // DOM elements
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const startScreen = document.getElementById('startScreen');
        const startButton = document.getElementById('startButton');
        const bellButton = document.getElementById('bellButton');
        const targetFrame = document.getElementById('targetFrame');
        const instructions = document.getElementById('instructions');
        const arOverlay = document.getElementById('arOverlay');
        const bgMusic = document.getElementById('bgMusic');
        const status = document.getElementById('status');

        // Start button handler
        startButton.addEventListener('click', async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { 
                        facingMode: 'environment',
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                });
                
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    startScreen.style.display = 'none';
                    loadTargetImage();
                };
            } catch (error) {
                console.error('[v0] Camera error:', error);
                alert('Unable to access camera. Please ensure permissions are granted.');
            }
        });

        // Load target image
        function loadTargetImage() {
            const img = new Image();
            img.crossOrigin = 'anonymous';
            img.onload = () => {
                state.targetImage = img;
                showStatus('Target image loaded. Align image in frame.');
                startTracking();
            };
            img.onerror = () => {
                console.error('[v0] Failed to load target image');
                showStatus('Target image not found. Using camera tracking.');
                startTracking();
            };
            img.src = CONFIG.targetImageSrc;
        }

        // Show status message
        function showStatus(message, duration = 3000) {
            status.textContent = message;
            status.classList.add('show');
            setTimeout(() => status.classList.remove('show'), duration);
        }

        // Start tracking loop
        function startTracking() {
            state.isTracking = true;
            requestAnimationFrame(trackingLoop);
        }

        // Main tracking loop
        function trackingLoop() {
            if (!state.isTracking) return;

            if (state.isLocked) {
                // If locked, just keep the AR overlay at the locked position
                requestAnimationFrame(trackingLoop);
                return;
            }

            // Draw current frame to canvas
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // Check if image is in target frame
            const isInFrame = detectImageInFrame();

            if (isInFrame) {
                state.stableCount++;
                if (state.stableCount >= CONFIG.stableFrames) {
                    // Show bell button
                    bellButton.classList.add('visible');
                    showStatus('Image detected! Click the bell to start.', 1000);
                }
            } else {
                state.stableCount = 0;
                bellButton.classList.remove('visible');
            }

            requestAnimationFrame(trackingLoop);
        }

        // Detect image in target frame (simplified detection)
        function detectImageInFrame() {
            if (!state.targetImage) return false;

            // Get target frame position on video
            const videoRect = video.getBoundingClientRect();
            const frameRect = targetFrame.getBoundingClientRect();
            
            // Calculate relative position on canvas
            const x = ((frameRect.left - videoRect.left) / videoRect.width) * canvas.width;
            const y = ((frameRect.top - videoRect.top) / videoRect.height) * canvas.height;
            const w = (frameRect.width / videoRect.width) * canvas.width;
            const h = (frameRect.height / videoRect.height) * canvas.height;

            // Simple brightness check in the frame area
            const imageData = ctx.getImageData(x, y, w, h);
            const data = imageData.data;
            let brightness = 0;
            
            for (let i = 0; i < data.length; i += 4) {
                brightness += (data[i] + data[i + 1] + data[i + 2]) / 3;
            }
            
            brightness /= (data.length / 4);
            
            // Consider detected if brightness is in reasonable range
            return brightness > 50 && brightness < 200;
        }

        // Bell button click handler
        bellButton.addEventListener('click', async () => {
            if (state.isLocked) return;

            // Lock the position
            state.isLocked = true;
            bellButton.classList.remove('visible');
            targetFrame.classList.add('hidden');
            instructions.style.display = 'none';

            // Get locked position (center of target frame)
            const videoRect = video.getBoundingClientRect();
            const frameRect = targetFrame.getBoundingClientRect();
            
            state.lockedPosition = {
                x: frameRect.left - videoRect.left + frameRect.width / 2,
                y: frameRect.top - videoRect.top + frameRect.height / 2,
                width: frameRect.width,
                height: frameRect.height
            };

            showStatus('🔒 Position locked! Starting Dharshan...', 2000);

            // Start music
            try {
                bgMusic.currentTime = 0;
                await bgMusic.play();
            } catch (error) {
                console.error('[v0] Audio play error:', error);
            }

            // Show aarti animation
            await showAartiAnimation();

            // Start playing GIFs sequentially
            playGifsSequentially();
        });

        // Show aarti animation
        async function showAartiAnimation() {
            return new Promise((resolve) => {
                const aartiContainer = document.createElement('div');
                aartiContainer.className = 'aarti-container active';
                aartiContainer.style.left = `${state.lockedPosition.x - state.lockedPosition.width / 2}px`;
                aartiContainer.style.top = `${state.lockedPosition.y - state.lockedPosition.height / 2}px`;
                aartiContainer.style.width = `${state.lockedPosition.width}px`;
                aartiContainer.style.height = `${state.lockedPosition.height}px`;

                // Add lamp
                const lamp = document.createElement('div');
                lamp.className = 'lamp';
                lamp.innerHTML = `
                    <svg viewBox="0 0 100 100" fill="#FFD700">
                        <path d="M50 10 L60 30 L80 30 L65 45 L70 65 L50 50 L30 65 L35 45 L20 30 L40 30 Z"/>
                        <circle cx="50" cy="50" r="15" fill="#FFA500"/>
                        <path d="M45 65 L45 80 L55 80 L55 65" fill="#8B4513"/>
                    </svg>
                `;
                aartiContainer.appendChild(lamp);

                // Add flowers
                const flowers = ['🌸', '🌸', '🌸', '🌸', '🌸'];
                for (let i = 0; i < 8; i++) {
                    const flower = document.createElement('div');
                    flower.className = 'flower';
                    flower.textContent = flowers[Math.floor(Math.random() * flowers.length)];
                    flower.style.left = `${Math.random() * 100}%`;
                    flower.style.animationDelay = `${Math.random() * 0.5}s`;
                    aartiContainer.appendChild(flower);
                }

                // Add smoke
                for (let i = 0; i < 5; i++) {
                    const smoke = document.createElement('div');
                    smoke.className = 'smoke';
                    smoke.style.left = `${20 + Math.random() * 60}%`;
                    smoke.style.animationDelay = `${Math.random() * 0.5}s`;
                    aartiContainer.appendChild(smoke);
                }

                arOverlay.appendChild(aartiContainer);

                // Remove after duration
                setTimeout(() => {
                    aartiContainer.remove();
                    resolve();
                }, CONFIG.aartiDuration);
            });
        }

        // Play GIFs sequentially
        async function playGifsSequentially() {
            state.isPlaying = true;

            for (let i = 0; i < CONFIG.gifSources.length; i++) {
                if (!state.isLocked) break;

                const gifElement = document.createElement('img');
                gifElement.className = 'gif-overlay';
                gifElement.style.left = `${state.lockedPosition.x - state.lockedPosition.width / 2}px`;
                gifElement.style.top = `${state.lockedPosition.y - state.lockedPosition.height / 2}px`;
                gifElement.style.width = `${state.lockedPosition.width}px`;
                gifElement.style.height = `${state.lockedPosition.height}px`;

                // Load GIF
                await new Promise((resolve) => {
                    gifElement.onload = () => {
                        gifElement.classList.add('active');
                        arOverlay.appendChild(gifElement);
                        
                        // Play for 3 seconds
                        setTimeout(() => {
                            gifElement.remove();
                            resolve();
                        }, 3000);
                    };
                    
                    gifElement.onerror = () => {
                        console.error(`[v0] Failed to load ${CONFIG.gifSources[i]}`);
                        resolve();
                    };
                    
                    gifElement.src = CONFIG.gifSources[i];
                });
            }

            // Loop back to first GIF
            if (state.isLocked) {
                playGifsSequentially();
            }
        }

        // Handle page visibility change
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) {
                bgMusic.pause();
            } else if (state.isPlaying && state.isLocked) {
                bgMusic.play().catch(e => console.error('[v0] Resume audio error:', e));
            }
        });

        console.log('[v0] AR Image Tracking initialized');
    </script>
</body>
</html>
