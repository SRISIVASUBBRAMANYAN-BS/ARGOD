<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GRAPHITE SKETCH</title>
  <style>
    :root{
      --bg:#0b0b0b;         /* background */
      --fg:#f9fafb;         /* foreground */
      --gold:#f6c445;       /* primary */
      --accent:#ff7a1a;     /* accent */
      --muted:#151618;      /* neutral card */
      --ok:#19c37d;         /* success */
      --danger:#ff4d4f;     /* danger */
      --radius:16px;
      --shadow:0 10px 35px rgba(0,0,0,.35);
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;
      overflow:hidden;
    }

    /* Start screen */
    .screen{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,#0a0b0d 0%, #0e0f12 100%);
      z-index:20;
    }
    #startCard{
      background:linear-gradient(180deg,#111214,#0b0c0e);
      border:1px solid #1f2023; border-radius:var(--radius);
      padding:24px; width:min(92vw,380px);
      box-shadow:var(--shadow);
      display:flex; flex-direction:column; gap:14px; text-align:center;
    }
    .title{
      font-weight:800; font-size:22px; letter-spacing:.2px; line-height:1.2;
      background:linear-gradient(180deg,#ffffff,#cbcbcb); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-wrap:balance;
    }
    .sub{font-size:13px; opacity:.85}
    .actions{display:flex; gap:12px; flex-wrap:wrap; justify-content:center; margin-top:6px}
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer; user-select:none;
      padding:12px 18px; border-radius:999px; font-weight:700; font-size:14px; letter-spacing:.2px;
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      box-shadow:var(--shadow); transition:.2s transform, .2s opacity, .2s box-shadow;
      background:linear-gradient(135deg,var(--gold),var(--accent)); color:#111;
    }
    .btn:active{transform:scale(.98)}
    .btn.secondary{
      background:#1b1c1f; color:#e5e7eb; border:1px solid #2a2c31; box-shadow:none;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px; font-size:12px; background:#121316; border:1px solid #23252a; padding:8px 12px; border-radius:999px; color:#cbd5e1; justify-content:center;
    }

    /* Stage */
    #stage{position:relative; width:100vw; height:100vh; overflow:hidden}
    #video{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.96) contrast(1.02);
    }
    #canvas{display:none}

    /* UI overlay */
    #ui{position:absolute; inset:0; pointer-events:none}
    #loc{
      position:absolute; top:14px; right:14px; pointer-events:auto; z-index:2;
    }
    .toast{
      position:absolute; top:64px; left:50%; transform:translateX(-50%);
      background:#0f1013; border:1px solid #22252b; font-size:12px; padding:8px 12px; border-radius:10px; display:none; z-index:3;
    }
    .toast.show{display:block}
    #status{
      position:absolute; bottom:16px; left:50%; transform:translateX(-50%);
      background:#101114; border:1px solid #23252a; color:#e5e7eb; padding:8px 12px; border-radius:10px; font-size:12px;
      display:none; z-index:3;
    }
    #status.show{display:block}

    /* Badges bottom-left */
    #badges{position:absolute; bottom:16px; left:16px; display:flex; gap:8px; align-items:center; z-index:2}
    .badge{font-size:11px; opacity:.75; background:#101114; border:1px solid #23252a; padding:6px 8px; border-radius:8px}

    /* Bell button (inline SVG, no external image) */
    #bell{
      position:absolute; bottom:24px; left:50%; transform:translateX(-50%);
      width:74px; height:74px; border-radius:999px; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--gold),var(--accent)); color:#111;
      box-shadow:0 10px 32px rgba(246,196,69,.35), inset 0 0 0 2px rgba(255,255,255,.35);
      transition:transform .2s ease, opacity .2s ease, box-shadow .2s ease;
      pointer-events:auto; opacity:1; z-index:2;
    }
    #bell:active{transform:translateX(-50%) scale(.96)}
    #bell svg{width:34px; height:34px; fill:#111}

    /* Flowers */
    .flower{
      position:absolute; top:-10%; font-size:28px; filter:drop-shadow(0 4px 10px rgba(0,0,0,.45));
      animation:fall 3.6s linear forwards;
      z-index:1;
    }
    @keyframes fall{
      0%{transform:translateY(-10%) rotate(0deg); opacity:0}
      6%{opacity:1}
      100%{transform:translateY(115vh) rotate(360deg); opacity:.0}
    }

    /* GIF overlay (or fallback) */
    .overlay{
      position:absolute; object-fit:cover; border-radius:12px; display:none;
      box-shadow:0 8px 32px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.08);
      z-index:2;
    }
    .overlay.show{display:block}
  </style>
</head>
<body>
   Start 
  <div class="screen" id="start">
    <div id="startCard">
      <div class="pill" aria-live="polite">
        <span>Camera + Location</span>
        <span style="width:6px;height:6px;border-radius:50%;background:var(--ok);display:inline-block"></span>
      </div>
      <h1 class="title">GRAPHITE SKETCH AR DARSHAN</h1>
      <p class="sub">Simple. Tap Start.</p>
      <div class="actions">
        <button class="btn" id="go">
          <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.012 10.012 0 0 0 12 2Zm1 14.93V13h3.93A8.016 8.016 0 0 1 13 16.93ZM7.07 11A5.014 5.014 0 0 1 11 7.07V11ZM13 11V7.07A5.014 5.014 0 0 1 16.93 11Zm-2 2v3.93A8.016 8.016 0 0 1 7.07 13ZM4.07 13H7v3a1 1 0 0 0 1 1h3v2.93A8.013 8.013 0 0 1 4.07 13ZM20 13A8.013 8.013 0 0 1 13 20v-3h3a1 1 0 0 0 1-1v-3Z"></path></svg>
          Start
        </button>
        <button class="btn secondary" id="locOnly">Enable Location</button>
      </div>
    </div>
  </div>

   Stage 
  <div id="stage" role="application" aria-label="AR Flowers stage">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <div id="ui" aria-hidden="false">
      <div id="loc">
        <div class="pill" id="locText">Loc: â€” , â€”</div>
      </div>

      <div class="toast" id="toast"></div>
      <div id="status" aria-live="polite"></div>

      <button id="bell" aria-label="Start">
         Inline bell icon (no external image) 
        <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
          <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6v-5c0-3.1-1.6-5.6-4.5-6.3V4a1.5 1.5 0 0 0-3 0v.7C7.6 5.4 6 8 6 11v5l-2 2v1h16v-1Z"/>
        </svg>
      </button>

      <div id="badges">
        <div class="badge" id="camBadge">Camera: â€”</div>
        <div class="badge" id="geoBadge">Location: â€”</div>
      </div>
    </div>
  </div>

   Optional song file. If missing, a soft tone fallback will play. 
  <audio id="bgMusic" loop>
    <source src="song.mp3" type="audio/mpeg" />
  </audio>

  <script>
    // Elements
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const startScreen = document.getElementById('start');
    const btnGo = document.getElementById('go');
    const btnLocOnly = document.getElementById('locOnly');

    const bell = document.getElementById('bell');
    const locText = document.getElementById('locText');
    const toast = document.getElementById('toast');
    const statusEl = document.getElementById('status');
    const camBadge = document.getElementById('camBadge');
    const geoBadge = document.getElementById('geoBadge');

    const bgMusic = document.getElementById('bgMusic');

    // Config
    const CONFIG = {
      flowersBurstCount: 240,     // more flowers
      flowersBurstDuration: 3800, // ms
      gifDuration: 2600,          // ms each
      overlaySize: 280,           // px
      desiredRadiusMeters: 5      // require proximity to saved location
    };

    // Provide GIF names next to this HTML (optional). If missing, we show a sparkle fallback.
    const GIFS = ['1.gif', '2.gif', '2.gif'];

    const state = {
      locked: false,
      isPlaying: false,
      hasCamera: false,
      hasLocation: false,
      currentLat: null,
      currentLon: null,
      savedLat: null,
      savedLon: null,
      lockPos: null
    };

    function showToast(msg, ms=1500){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), ms);
    }

    function showStatus(msg, ms=1200){
      statusEl.textContent = msg;
      statusEl.classList.add('show');
      setTimeout(()=>statusEl.classList.remove('show'), ms);
    }

    function setBadges(){
      camBadge.textContent = 'Camera: ' + (state.hasCamera ? 'On' : 'Off');
      geoBadge.textContent = 'Location: ' + (state.hasLocation ? 'On' : 'Off');
    }

    // Haversine distance
    function metersBetween(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Geo
    function requestGeo(){
      if(!('geolocation' in navigator)){
        showToast('Geolocation not supported', 2000);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const { latitude, longitude } = pos.coords;
          state.currentLat = latitude;
          state.currentLon = longitude;
          state.hasLocation = true;
          locText.textContent = 'Loc: ' + latitude.toFixed(6) + ', ' + longitude.toFixed(6);
          setBadges();
          showStatus('Location enabled');
        },
        ()=>{
          state.hasLocation = false;
          setBadges();
          showToast('Enable location to continue', 1800);
        },
        { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
      );
      // Watch for updates
      try{
        navigator.geolocation.watchPosition((pos)=>{
          state.currentLat = pos.coords.latitude;
          state.currentLon = pos.coords.longitude;
          locText.textContent = 'Loc: ' + state.currentLat.toFixed(6) + ', ' + state.currentLon.toFixed(6);
          // If user moves away from saved location, stop overlay
          if(state.savedLat!=null){
            const d = metersBetween(state.savedLat, state.savedLon, state.currentLat, state.currentLon);
            if(d > CONFIG.desiredRadiusMeters){
              if(state.isPlaying){
                stopOverlay();
                showStatus('Return to saved spot', 1200);
              }
            }
          }
        });
      }catch{}
    }

    // Camera
    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} },
          audio:false
        });
        video.srcObject = stream;
        await new Promise(r=> video.onloadedmetadata = r);
        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        state.hasCamera = true;
        setBadges();
        showStatus('Camera started');
      }catch{
        state.hasCamera = false;
        setBadges();
        showToast('Camera permission needed', 1800);
      }
    }

    // Music
    let audioCtx = null, osc = null, gain = null;
    async function startMusic(){
      try{
        bgMusic.currentTime = 0;
        await bgMusic.play();
      }catch{
        // Fallback soft tone if no mp3
        try{
          if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          osc = audioCtx.createOscillator();
          gain = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.value = 432;
          gain.gain.value = 0.06;
          osc.connect(gain).connect(audioCtx.destination);
          osc.start();
        }catch{}
      }
    }
    function stopMusic(){
      try{ bgMusic.pause(); }catch{}
      try{
        if(osc){ osc.stop(); osc.disconnect(); osc = null; }
        if(gain){ gain.disconnect(); gain = null; }
      }catch{}
    }

    // Flowers (no smoke, no aarti)
    function flowerEmoji(){
      const set = ['ðŸŒ¸','ðŸŒ¸','ðŸ’®','ðŸŒ¸','ðŸ’®','ðŸ’®'];
      return set[(Math.random()*set.length)|0];
    }
    function burstFlowers(ms=CONFIG.flowersBurstDuration, count=CONFIG.flowersBurstCount){
      const stage = document.getElementById('stage');
      const start = performance.now();
      let spawned = 0;

      function spawnOne(){
        const d = document.createElement('div');
        d.className = 'flower';
        d.textContent = flowerEmoji();
        d.style.left = (Math.random()*100) + 'vw';
        d.style.fontSize = (24 + Math.random()*12) + 'px';
        d.style.animationDuration = (2.4 + Math.random()*2.2) + 's';
        stage.appendChild(d);
        setTimeout(()=>d.remove(), 4200);
      }

      function tick(now){
        if(now - start < ms && spawned < count){
          for(let i=0;i<5;i++){ // heavier
            spawnOne(); spawned++;
            if(spawned >= count) break;
          }
          requestAnimationFrame(tick);
        }
      }
      requestAnimationFrame(tick);
    }

    // Overlay control
    let overlayEl = null, fallbackEl = null, overlayTimer = null;
    function setOverlayRect(){
      if(!state.lockPos) return;
      const el = overlayEl || fallbackEl;
      if(!el) return;
      el.style.left = (state.lockPos.x - state.lockPos.w/2) + 'px';
      el.style.top  = (state.lockPos.y - state.lockPos.h/2) + 'px';
      el.style.width = state.lockPos.w + 'px';
      el.style.height= state.lockPos.h + 'px';
    }
    function stopOverlay(){
      state.locked = false;
      state.isPlaying = false;
      if(overlayTimer){ clearTimeout(overlayTimer); overlayTimer = null; }
      if(overlayEl){ overlayEl.remove(); overlayEl = null; }
      if(fallbackEl){ fallbackEl.remove(); fallbackEl = null; }
      stopMusic();
    }

    async function playGifsAtLocked(){
      overlayEl = document.createElement('img');
      overlayEl.className = 'overlay';
      document.body.appendChild(overlayEl);

      fallbackEl = document.createElement('div');
      fallbackEl.className = 'overlay';
      fallbackEl.style.backdropFilter = 'blur(2px)';
      fallbackEl.style.background = 'linear-gradient(135deg, rgba(246,196,69,.25), rgba(255,122,26,.25))';
      fallbackEl.style.color = '#fff';
      fallbackEl.style.fontSize = '42px';
      fallbackEl.style.display = 'grid';
      fallbackEl.style.placeItems = 'center';
      fallbackEl.textContent = 'âœ¨';
      document.body.appendChild(fallbackEl);

      setOverlayRect();

      const runOne = (src)=> new Promise((resolve)=>{
        let showed = false;
        overlayEl.onload = ()=>{
          fallbackEl.style.display = 'none';
          overlayEl.classList.add('show');
          showed = true;
          overlayTimer = setTimeout(()=>resolve(), CONFIG.gifDuration);
        };
        overlayEl.onerror = ()=>{
          overlayEl.classList.remove('show');
          fallbackEl.style.display = 'grid';
          overlayTimer = setTimeout(()=>resolve(), CONFIG.gifDuration);
        };
        overlayEl.src = src + '?t=' + Date.now();
      });

      state.isPlaying = true;
      while(state.locked){
        // If moved away, stop
        if(state.savedLat!=null && state.currentLat!=null){
          const d = metersBetween(state.savedLat, state.savedLon, state.currentLat, state.currentLon);
          if(d > CONFIG.desiredRadiusMeters){
            stopOverlay();
            showStatus('Return to saved spot', 1100);
            break;
          }
        }
        for(const src of GIFS){
          if(!state.locked) break;
          await runOne(src);
          setOverlayRect();
        }
      }
    }

    // Bell
    bell.addEventListener('click', async ()=>{
      if(state.locked) return;

      // Require location
      if(!state.hasLocation || state.currentLat==null){
        showToast('Enable location first', 1500);
        return;
      }

      // Save desired location now
      state.savedLat = state.currentLat;
      state.savedLon = state.currentLon;

      // Gate: must be near saved location (first time always passes)
      const d = metersBetween(state.savedLat, state.savedLon, state.currentLat, state.currentLon);
      if(d > CONFIG.desiredRadiusMeters){
        showStatus('Go to your saved spot', 1200);
        return;
      }

      // Lock UI position (center of screen)
      const vr = video.getBoundingClientRect();
      state.lockPos = {
        x: vr.left + vr.width/2,
        y: vr.top  + vr.height/2,
        w: Math.min(280, vr.width*0.55),
        h: Math.min(280, vr.height*0.55),
      };

      state.locked = true;
      showStatus('Starting', 900);
      await startMusic();

      // More flowers first
      burstFlowers();

      // Then GIFs loop
      playGifsAtLocked();
    });

    // Start
    btnGo.addEventListener('click', async ()=>{
      requestGeo();
      await startCamera();
      startScreen.style.display = 'none';
      showToast('Ready');
    });

    btnLocOnly.addEventListener('click', ()=>{
      requestGeo();
      showStatus('Requesting locationâ€¦');
    });

    // Resume/stop music on visibility change
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){
        stopMusic();
      }else if(state.locked){
        startMusic();
      }
    });

    // Resize keeps canvas in sync and overlay centered
    window.addEventListener('resize', ()=>{
      if(video.videoWidth){
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        setOverlayRect();
      }
    });
  </script>
</body>
</html>
