<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>GRAPHITE SKETCH</title>
  <style>
    :root{
      --bg:#0b0b0b;
      --fg:#f9fafb;
      --gold:#f6c445;
      --accent:#ff7a1a;
      --muted:#111214;
      --ok:#19c37d;
      --danger:#ff4d4f;
      --card:#151618;
      --shadow:0 10px 35px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{
      background:var(--bg);
      color:var(--fg);
      font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,Apple Color Emoji,Segoe UI Emoji,Segoe UI Symbol;
      overflow:hidden;
    }

    /* Start screen */
    .screen{
      position:fixed; inset:0; display:flex; align-items:center; justify-content:center;
    }
    #start{
      background:linear-gradient(135deg,#111214,#0a0b0d);
      gap:20px; flex-direction:column; text-align:center; padding:28px; min-width:280px; max-width:360px; border-radius:var(--radius);
      box-shadow:var(--shadow); border:1px solid #1f2023;
    }
    .title{
      font-weight:800; font-size:22px; letter-spacing:.2px; line-height:1.2;
      background:linear-gradient(180deg,#ffffff,#c7c7c7); -webkit-background-clip:text; background-clip:text; color:transparent;
      text-wrap:balance;
    }
    .sub{
      font-size:13px; opacity:.8;
    }
    .actions{display:flex; gap:12px; margin-top:8px; width:100%; justify-content:center; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; outline:none; cursor:pointer; user-select:none;
      padding:12px 18px; border-radius:999px; font-weight:700; font-size:14px; letter-spacing:.2px;
      display:inline-flex; gap:10px; align-items:center; justify-content:center;
      box-shadow:var(--shadow); transition:.2s transform, .2s opacity, .2s box-shadow;
      background:linear-gradient(135deg,var(--gold),var(--accent)); color:#1a1a1a;
    }
    .btn.secondary{
      background:#1b1c1f; color:#e5e7eb; border:1px solid #2a2c31; box-shadow:none;
    }
    .btn:active{transform:scale(.98)}
    .pill{
      display:inline-flex; align-items:center; gap:8px; font-size:12px; background:#121316; border:1px solid #23252a; padding:8px 12px; border-radius:999px; color:#cbd5e1;
    }

    /* Stage */
    #stage{position:relative; width:100vw; height:100vh; overflow:hidden}
    #video{
      position:absolute; inset:0; width:100%; height:100%; object-fit:cover; filter:brightness(.96) contrast(1.02);
    }
    #canvas{display:none}

    /* UI overlay */
    #ui{
      position:absolute; inset:0; pointer-events:none;
    }
    #frame{
      position:absolute; width:300px; height:300px; border-radius:18px;
      border:3px dashed var(--gold);
      top:50%; left:50%; transform:translate(-50%,-50%);
      box-shadow:0 0 32px rgba(246,196,69,.35);
      transition:opacity .25s ease;
    }
    #hint{
      position:absolute; top:18px; left:50%; transform:translateX(-50%);
      background:rgba(0,0,0,.55); border:1px solid rgba(255,255,255,.08);
      padding:10px 14px; border-radius:12px; font-size:12px; pointer-events:none; box-shadow:var(--shadow);
    }
    #status{
      position:absolute; bottom:18px; left:50%; transform:translateX(-50%);
      background:#101114; border:1px solid #23252a; color:#e5e7eb; padding:8px 12px; border-radius:10px; font-size:12px;
      display:none;
    }
    #status.show{display:block}

    /* Location chip */
    #loc{
      position:absolute; top:18px; right:18px; pointer-events:auto;
    }

    /* Bell (no external image) */
    #bell{
      position:absolute; bottom:24px; left:50%; transform:translateX(-50%);
      width:74px; height:74px; border-radius:999px; border:none; cursor:pointer;
      display:flex; align-items:center; justify-content:center;
      background:linear-gradient(135deg,var(--gold),var(--accent)); color:#111;
      box-shadow:0 10px 32px rgba(246,196,69,.35), inset 0 0 0 2px rgba(255,255,255,.35);
      transition:transform .2s ease, opacity .2s ease, box-shadow .2s ease;
      pointer-events:none; opacity:0;
    }
    #bell svg{width:34px; height:34px; fill:#111}
    #bell.visible{pointer-events:auto; opacity:1}
    #bell:active{transform:translateX(-50%) scale(.96)}

    /* Flowers */
    .flower{
      position:absolute; top:-10%; font-size:28px; filter:drop-shadow(0 4px 10px rgba(0,0,0,.45));
      animation:fall 3.6s linear forwards;
    }
    @keyframes fall{
      0%{transform:translateY(-10%) rotate(0deg); opacity:0}
      6%{opacity:1}
      100%{transform:translateY(115vh) rotate(360deg); opacity:.0}
    }

    /* GIF overlay (or fallback) */
    .overlay{
      position:absolute; object-fit:cover; border-radius:12px; display:none;
      box-shadow:0 8px 32px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.08);
    }
    .overlay.show{display:block}

    /* Tiny toasts */
    .toast{
      position:absolute; top:70px; left:50%; transform:translateX(-50%);
      background:#0f1013; border:1px solid #22252b; font-size:12px; padding:8px 12px; border-radius:10px; display:none;
    }
    .toast.show{display:block}

    /* Small badges bottom-left */
    #badges{
      position:absolute; bottom:16px; left:16px; display:flex; gap:8px; align-items:center;
    }
    .badge{font-size:11px; opacity:.7; background:#101114; border:1px solid #23252a; padding:6px 8px; border-radius:8px}

    /* Hide frame when locked */
    .hidden{opacity:0}
  </style>
</head>
<body>
   Start 
  <div class="screen" id="start">
    <div class="pill" aria-live="polite">
      <span>Camera + Location</span>
      <span style="width:6px;height:6px;border-radius:50%;background:var(--ok);display:inline-block"></span>
    </div>
    <h1 class="title">GRAPHITE SKETCH</h1>
    <p class="sub">AR DHARSHAN.</p>
    <div class="actions">
      <button class="btn" id="go">
        <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path d="M12 2a10 10 0 1 0 10 10A10.012 10.012 0 0 0 12 2Zm1 14.93V13h3.93A8.016 8.016 0 0 1 13 16.93ZM7.07 11A5.014 5.014 0 0 1 11 7.07V11ZM13 11V7.07A5.014 5.014 0 0 1 16.93 11Zm-2 2v3.93A8.016 8.016 0 0 1 7.07 13ZM4.07 13H7v3a1 1 0 0 0 1 1h3v2.93A8.013 8.013 0 0 1 4.07 13ZM20 13A8.013 8.013 0 0 1 13 20v-3h3a1 1 0 0 0 1-1v-3Z"></path></svg>
        Start
      </button>
      <button class="btn secondary" id="locOnly">Enable Location</button>
    </div>
  </div>

   Stage 
  <div id="stage" role="application" aria-label="AR Flowers stage">
    <video id="video" playsinline autoplay muted></video>
    <canvas id="canvas"></canvas>

    <div id="ui" aria-hidden="false">
      <div id="frame" aria-label="Align target"></div>
      <div id="hint" class="pill">Align inside the frame</div>

      <div id="loc">
        <div class="pill" id="locText">Loc: â€” , â€”</div>
      </div>

      <div class="toast" id="toast"></div>

      <button id="bell" aria-label="Start">
         Inline bell icon (no external image) 
        <svg viewBox="0 0 24 24" role="img" aria-hidden="true">
          <path d="M12 22a2 2 0 0 0 2-2h-4a2 2 0 0 0 2 2Zm6-6v-5c0-3.1-1.6-5.6-4.5-6.3V4a1.5 1.5 0 0 0-3 0v.7C7.6 5.4 6 8 6 11v5l-2 2v1h16v-1Z"/>
        </svg>
      </button>

      <div id="badges">
        <div class="badge" id="camBadge">Camera: â€”</div>
        <div class="badge" id="geoBadge">Location: â€”</div>
      </div>

      <div id="status" aria-live="polite"></div>
    </div>
  </div>

   Optional song file. If missing, a soft tone fallback will play. 
  <audio id="bgMusic" loop>
    <source src="song.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const video = document.getElementById('video');
    const canvas = document.getElementById('canvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const startScreen = document.getElementById('start');
    const btnGo = document.getElementById('go');
    const btnLocOnly = document.getElementById('locOnly');

    const frame = document.getElementById('frame');
    const hint = document.getElementById('hint');
    const bell = document.getElementById('bell');
    const locText = document.getElementById('locText');
    const toast = document.getElementById('toast');
    const statusEl = document.getElementById('status');
    const camBadge = document.getElementById('camBadge');
    const geoBadge = document.getElementById('geoBadge');

    const bgMusic = document.getElementById('bgMusic');

    // Config
    const CONFIG = {
      matchThreshold: 0.65,       // brightness range check (simple)
      stableFrames: 15,           // frames needed before showing bell
      flowersBurstCount: 160,     // more flowers
      flowersBurstDuration: 3500, // ms
      gifDuration: 2600,          // ms each
      overlaySize: 280,           // px
      desiredRadiusMeters: 5      // show current lat/lon; lock to captured location
    };

    // If you place GIFs next to this file, set paths here. If missing, a fallback sparkle appears.
    const GIFS = ['1.gif','2.gif','2.gif'];

    const state = {
      stableCount: 0,
      locked: false,
      isPlaying: false,
      lockPos: null,
      hasCamera: false,
      hasLocation: false,
      currentLat: null,
      currentLon: null,
      savedLat: null,
      savedLon: null
    };

    function showToast(msg, ms=1500){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), ms);
    }

    function showStatus(msg, ms=1200){
      statusEl.textContent = msg;
      statusEl.classList.add('show');
      setTimeout(()=>statusEl.classList.remove('show'), ms);
    }

    function setBadges(){
      camBadge.textContent = 'Camera: ' + (state.hasCamera ? 'On' : 'Off');
      geoBadge.textContent = 'Location: ' + (state.hasLocation ? 'On' : 'Off');
    }

    function metersBetween(lat1, lon1, lat2, lon2){
      const R = 6371000;
      const toRad = d => d*Math.PI/180;
      const dLat = toRad(lat2-lat1);
      const dLon = toRad(lon2-lon1);
      const a = Math.sin(dLat/2)**2 + Math.cos(toRad(lat1))*Math.cos(toRad(lat2))*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    // Geo
    function requestGeo(){
      if(!('geolocation' in navigator)){
        showToast('Geolocation not supported', 2000);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos)=>{
          const { latitude, longitude } = pos.coords;
          state.currentLat = latitude;
          state.currentLon = longitude;
          state.savedLat = latitude; // lock desired to actual
          state.savedLon = longitude;
          state.hasLocation = true;
          locText.textContent = 'Loc: ' + latitude.toFixed(6) + ', ' + longitude.toFixed(6);
          setBadges();
          showStatus('Location enabled');
        },
        (err)=>{
          state.hasLocation = false;
          setBadges();
          showToast('Enable location to continue', 1800);
        },
        { enableHighAccuracy:true, timeout:8000, maximumAge:0 }
      );
      // Watch position to update pill
      try{
        navigator.geolocation.watchPosition((pos)=>{
          state.currentLat = pos.coords.latitude;
          state.currentLon = pos.coords.longitude;
          locText.textContent = 'Loc: ' + state.currentLat.toFixed(6) + ', ' + state.currentLon.toFixed(6);
        });
      }catch{}
    }

    // Camera
    async function startCamera(){
      try{
        const stream = await navigator.mediaDevices.getUserMedia({
          video:{ facingMode:'environment', width:{ideal:1280}, height:{ideal:720} },
          audio:false
        });
        video.srcObject = stream;
        await new Promise(r=> video.onloadedmetadata = r);
        await video.play();

        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        state.hasCamera = true;
        setBadges();
        showStatus('Camera started');
        requestAnimationFrame(loop);
      }catch(err){
        state.hasCamera = false;
        setBadges();
        showToast('Camera permission needed', 1800);
      }
    }

    // Detection (simple)
    function loop(){
      if(state.locked) return;
      if(!video.videoWidth) return requestAnimationFrame(loop);

      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      // Area under frame
      const vr = video.getBoundingClientRect();
      const fr = frame.getBoundingClientRect();
      const x = ((fr.left - vr.left) / vr.width) * canvas.width;
      const y = ((fr.top  - vr.top)  / vr.height)* canvas.height;
      const w = (fr.width / vr.width) * canvas.width;
      const h = (fr.height/ vr.height)* canvas.height;

      let ok = false;
      try{
        const imageData = ctx.getImageData(x,y,w,h);
        const data = imageData.data;
        let brightness = 0;
        for(let i=0;i<data.length;i+=4){
          brightness += (data[i] + data[i+1] + data[i+2]) / 3;
        }
        brightness /= (data.length/4);
        // heuristic band
        ok = brightness > 50 && brightness < 200;
      }catch{ ok = false; }

      if(ok){
        state.stableCount++;
        if(state.stableCount >= CONFIG.stableFrames){
          bell.classList.add('visible');
        }
      }else{
        state.stableCount = 0;
        bell.classList.remove('visible');
      }

      requestAnimationFrame(loop);
    }

    // Music
    let audioCtx = null, osc = null, gain = null;
    async function startMusic(){
      try{
        bgMusic.currentTime = 0;
        await bgMusic.play();
      }catch{
        // Fallback soft tone if no mp3
        try{
          if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
          osc = audioCtx.createOscillator();
          gain = audioCtx.createGain();
          osc.type = 'sine';
          osc.frequency.value = 432; // calm
          gain.gain.value = 0.06;
          osc.connect(gain).connect(audioCtx.destination);
          osc.start();
        }catch{}
      }
    }
    function stopMusic(){
      try{ bgMusic.pause(); }catch{}
      try{
        if(osc){ osc.stop(); osc.disconnect(); osc = null; }
        if(gain){ gain.disconnect(); gain = null; }
      }catch{}
    }

    // Flower rain (no smoke, no aarti)
    function flowerEmoji(){
      const set = ['ðŸŒ¸','ðŸŒ¸','ðŸ’®','ðŸŒ¸','ðŸ’®','ðŸ’®'];
      return set[(Math.random()*set.length)|0];
    }
    function burstFlowers(ms=CONFIG.flowersBurstDuration, count=CONFIG.flowersBurstCount){
      const stage = document.getElementById('stage');
      const start = performance.now();
      let spawned = 0;

      function spawnOne(){
        const d = document.createElement('div');
        d.className = 'flower';
        d.textContent = flowerEmoji();
        d.style.left = (Math.random()*100) + 'vw';
        d.style.fontSize = (24 + Math.random()*12) + 'px';
        d.style.animationDuration = (2.6 + Math.random()*2.0) + 's';
        stage.appendChild(d);
        setTimeout(()=>d.remove(), 4200);
      }

      function tick(now){
        if(now - start < ms && spawned < count){
          // spawn fast
          for(let i=0;i<4;i++){
            spawnOne(); spawned++;
            if(spawned >= count) break;
          }
          requestAnimationFrame(tick);
        }
      }
      requestAnimationFrame(tick);
    }

    // GIF sequence (with fallback)
    async function playGifsAtLocked(){
      const overlay = document.createElement('img');
      overlay.className = 'overlay';
      document.body.appendChild(overlay);

      const setOverlayRect = ()=>{
        if(!state.lockPos) return;
        overlay.style.left = (state.lockPos.x - state.lockPos.w/2) + 'px';
        overlay.style.top  = (state.lockPos.y - state.lockPos.h/2) + 'px';
        overlay.style.width = state.lockPos.w + 'px';
        overlay.style.height= state.lockPos.h + 'px';
      };
      setOverlayRect();

      // fallback node
      const fallback = document.createElement('div');
      fallback.className = 'overlay';
      fallback.style.display = 'none';
      fallback.style.backdropFilter = 'blur(2px)';
      fallback.style.background = 'linear-gradient(135deg, rgba(246,196,69,.2), rgba(255,122,26,.2))';
      fallback.style.color = '#fff';
      fallback.style.fontSize = '42px';
      fallback.style.display = 'grid';
      fallback.style.placeItems = 'center';
      fallback.textContent = 'âœ¨';
      document.body.appendChild(fallback);
      const setFallbackRect = ()=>{
        if(!state.lockPos) return;
        fallback.style.left = (state.lockPos.x - state.lockPos.w/2) + 'px';
        fallback.style.top  = (state.lockPos.y - state.lockPos.h/2) + 'px';
        fallback.style.width = state.lockPos.w + 'px';
        fallback.style.height= state.lockPos.h + 'px';
      };
      setFallbackRect();

      const runOne = (src)=> new Promise((resolve)=>{
        let shown = false;
        overlay.onload = ()=>{
          fallback.style.display = 'none';
          overlay.classList.add('show');
          shown = true;
          setTimeout(()=>resolve(), CONFIG.gifDuration);
        };
        overlay.onerror = ()=>{
          overlay.classList.remove('show');
          // fallback sparkle
          fallback.style.display = 'block';
          setTimeout(()=>resolve(), CONFIG.gifDuration);
        };
        overlay.src = src + '?t=' + Date.now(); // bust cache
      });

      // loop forever while locked
      state.isPlaying = true;
      while(state.locked){
        for(const src of GIFS){
          await runOne(src);
          setOverlayRect(); setFallbackRect();
          if(!state.locked) break;
        }
      }
      overlay.remove();
      fallback.remove();
    }

    // Bell
    bell.addEventListener('click', async ()=>{
      if(state.locked) return;

      // ensure we display at saved location (just record now)
      state.savedLat = state.currentLat;
      state.savedLon = state.currentLon;

      // lock UI position (center of frame on screen)
      const vr = video.getBoundingClientRect();
      const fr = frame.getBoundingClientRect();
      state.lockPos = {
        x: fr.left - vr.left + fr.width/2,
        y: fr.top  - vr.top  + fr.height/2,
        w: Math.min(fr.width, CONFIG.overlaySize),
        h: Math.min(fr.height, CONFIG.overlaySize),
      };

      state.locked = true;
      bell.classList.remove('visible');
      frame.classList.add('hidden');
      hint.classList.add('hidden');

      showStatus('Starting', 900);
      await startMusic();

      // big flower rain
      burstFlowers();

      // then gifs
      playGifsAtLocked();
    });

    // Start button
    btnGo.addEventListener('click', async ()=>{
      requestGeo();
      await startCamera();
      startScreen.style.display = 'none';
    });

    btnLocOnly.addEventListener('click', ()=>{
      requestGeo();
      showStatus('Requesting locationâ€¦');
    });

    // Resume music on visibility change
    document.addEventListener('visibilitychange', ()=>{
      if(document.hidden){ stopMusic(); }
      else if(state.locked){ startMusic(); }
    });

    // Resize handler updates canvas and keeps UI sensible
    window.addEventListener('resize', ()=>{
      if(video.videoWidth){
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
      }
    });

    // Small periodic check to ensure the overlay is used at saved lat/lon (displayed pill)
    setInterval(()=>{
      if(state.savedLat!=null && state.currentLat!=null){
        const d = metersBetween(state.savedLat, state.savedLon, state.currentLat, state.currentLon);
        // display a quiet badge if moved away
        if(d > CONFIG.desiredRadiusMeters){
          showStatus('Stay near your saved location', 800);
        }
      }
    }, 4000);
  </script>
</body>
</html>
